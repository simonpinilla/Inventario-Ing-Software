<script>
    $(document).ready(function () {
        $('#btn_agregar_producto').on('click', function () {
            var productoSeleccionado = $('#id_productos option:selected').text();
            var cantidadSeleccionada = $('#id_cantidad').val();

            // Validar la entrada del usuario (cantidad)
            if (cantidadSeleccionada === '') {
                alert('Por favor, ingrese una cantidad.');
                return;
            }

            // Agregar una fila a la tabla de productos seleccionados
            var fila = '<tr>' +
                '<td>' + productoSeleccionado + '</td>' +
                '<td>' + cantidadSeleccionada + '</td>' +
                '<td><button type="button" class="btn btn-danger btn-sm eliminar-producto">Eliminar</button></td>' +
                '</tr>';
            $('#tabla_productos_seleccionados').append(fila);
        });

        // Eliminar producto al hacer clic en el botÃ³n "Eliminar"
        $(document).on('click', '.eliminar-producto', function () {
            var filaEliminada = $(this).closest('tr');
            var precioEliminado = parseFloat(filaEliminada.find('td:eq(2)').text());
            var cantidadEliminada = parseInt(filaEliminada.find('td:eq(1)').text());

            var precioTotalActual = parseFloat($('#precio-total').text());
            precioTotalActual -= precioEliminado * cantidadEliminada;
            $('#precio-total').text(precioTotalActual.toFixed(0)); // Mostrar el precio total sin decimales

            var cantidadTotalActual = parseInt($('#cantidad-total').text());
            cantidadTotalActual -= cantidadEliminada;
            $('#cantidad-total').text(cantidadTotalActual);

            filaEliminada.remove(); // Eliminar la fila correspondiente
        });
        
    });
    $(document).on('click', '.btn_agregar_producto', function () {
        var filaEncontrada = $(this).closest('tr');
        var productoSeleccionado = {
            nombre: filaEncontrada.find('td:eq(0)').text(),
            precio: parseFloat(filaEncontrada.find('td:eq(2)').text())
        };

        var cantidadSeleccionada = parseInt(filaEncontrada.find('input').val());
        var stockDisponible = parseInt($(this).data('stock'));

        // Verificar la cantidad total del producto seleccionado ya agregado
        var cantidadTotalProducto = 0;
        $('#tabla_productos_seleccionados tr').each(function () {
            var nombreProducto = $(this).find('td:eq(0)').text();
            var cantidadProducto = parseInt($(this).find('td:eq(1)').text());

            if (nombreProducto === productoSeleccionado.nombre) {
                cantidadTotalProducto += cantidadProducto;
            }
        });

        // Verificar si la cantidad total excede el stock
        if (cantidadTotalProducto + cantidadSeleccionada > stockDisponible) {
            alert('La cantidad total seleccionada del producto excede el stock disponible.');
            return;
        }

        var precioTotalPorProducto = productoSeleccionado.precio * cantidadSeleccionada;
        // Actualizar el precio total
        var precioTotalActual = parseFloat($('#precio-total').text());
        precioTotalActual += precioTotalPorProducto;
        $('#precio-total').text(precioTotalActual.toFixed(0));// Mostrar el precio total con dos decimales


        // Actualizar la cantidad total de productos seleccionados
        var cantidadTotalActual = parseInt($('#cantidad-total').text());
        cantidadTotalActual += cantidadSeleccionada;
        $('#cantidad-total').text(cantidadTotalActual);


        // Agregar el producto a la tabla de productos seleccionados
        var fila = '<tr>' +
            '<td>' + productoSeleccionado.nombre + '</td>' +
            '<td>' + cantidadSeleccionada + '</td>' +
            '<td>' + productoSeleccionado.precio + '</td>' +
            '<td><button type="button" class="btn btn-danger btn-sm eliminar-producto">Eliminar</button></td>' +
            '</tr>';
        $('#tabla_productos_seleccionados').append(fila);
    });




    $(document).on('click', '#btn_buscar', function () {
        var query = $('#id_buscar_producto').val();
        if (query !== '') {
            $.ajax({
                url: "{% url 'buscar_productos' %}",  // URL de la vista para buscar productos
                method: 'GET',
                data: { 'query': query },
                dataType: 'json',
                success: function (data) {
                    if (Array.isArray(data.productos)) {
                        $('#tabla_productos_buscados').empty();
                        data.productos.forEach(function (producto) {
                            var fila = '<tr>' +
                                '<td>' + producto.nombre + '</td>' +
                                '<td>' + producto.cantidad + '</td>' +
                                '<td>' + producto.precio + '</td>' +
                                '<td><button type="button" class="btn btn-primary btn_agregar_producto" data-stock="' + producto.cantidad + '">Agregar</button></td>' +
                                '<td><div class="input-group mb-3" style="width: 130px;">' +
                                '<button type="button" class="input-group-text" data-stock="' + producto.cantidad + '">-</button>' +
                                '<input type="text" class="form-control text-center bg-white" value="1" disabled>' +
                                '<button type="button" class="input-group-text" data-stock="' + producto.cantidad + '">+</button>' +
                                '</div></td>' +
                                '</tr>';
                            $('#tabla_productos_buscados').append(fila);
                        });
                    } else {
                        alert('No se encontraron productos.');
                    }
                },
                error: function () {
                    alert('Error al buscar productos.');
                }
            });
        }
    });
    $(document).on('click', '.input-group-text', function (event) {
        var input = $(this).siblings('input');
        var valor = parseInt(input.val());
        var stock = parseInt($(this).data('stock'));

        if ($(this).text() === '+' && valor < stock) {
            input.val(valor + 1);
        } else if ($(this).text() === '-' && valor > 1) {
            input.val(valor - 1);
        }

        $(this).siblings('input').attr('data-cantidad-seleccionada', input.val());
    });
    
    
</script>